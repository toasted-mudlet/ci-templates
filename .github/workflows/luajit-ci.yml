# LuaJIT CI workflow: runs linting, testing, and coverage for Lua projects using LuaJIT.
# Dependencies are installed using Lua 5.1 to work around LuaJIT's manifest size limitation with LuaRocks.
# Then, tests and tools are executed with the specified LuaJIT version.

name: LuaJIT CI

on:
  workflow_call:
    inputs:
      lua-version:
        description: 'LuaJIT version to use (e.g., luajit-2.1.0-beta3)'
        required: false
        default: 'luajit-2.1.0-beta3'
        type: string

jobs:
  luajit-ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Lua 5.1 for dependency install
        uses: leafo/gh-actions-lua@v11
        with:
          luaVersion: 5.1.5

      - name: Set up LuaRocks
        uses: leafo/gh-actions-luarocks@v4

      - name: Install dependencies (with Lua 5.1)
        run: |
          luarocks install --tree=lua_modules --deps-only *.rockspec
          luarocks install --tree=lua_modules busted
          luarocks install --tree=lua_modules luacov
          luarocks install --tree=lua_modules luacheck

      - name: Set up LuaJIT
        uses: leafo/gh-actions-lua@v11
        with:
          luaVersion: ${{ inputs.lua-version }}

      - name: Set up LuaRocks for LuaJIT (for correct environment)
        uses: leafo/gh-actions-luarocks@v4

      - name: Override luacheck std for LuaJIT
        run: |
          echo 'std = "lua51"' >> .luacheckrc
          echo "Using luacheck std: lua51"

      - name: Lint code with luacheck
        run: ./lua_modules/bin/luacheck .

      - name: Run tests with coverage
        run: ./lua_modules/bin/busted --coverage .

      - name: Generate coverage report
        run: ./lua_modules/bin/luacov

      - name: Show coverage report
        run: cat luacov.report.out

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: luacov.report.${{ inputs.lua-version }}.out
          path: luacov.report.out
